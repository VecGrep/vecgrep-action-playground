name: "Test: validate mode"

on:
  push:
    branches: [main]
  pull_request:

jobs:
  validate:
    name: Architectural validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # --- Blocking checks (fail_on_match) ---
      # High min_score to avoid false positives — only fail on clear matches.

      # Must pass — no raw SQL in this codebase (uses parameterized queries)
      - name: Ensure no raw SQL string concatenation
        uses: VecGrep/action@v0.1.5
        with:
          mode: validate
          query: "raw SQL string concatenation format f-string execute cursor unsafe"
          path: src/
          min_score: "0.80"
          fail_on_match: "true"

      # Must pass — no hardcoded credentials
      - name: Ensure no hardcoded credentials
        uses: VecGrep/action@v0.1.5
        with:
          mode: validate
          query: "hardcoded password secret api key token credential plaintext"
          path: src/
          min_score: "0.78"
          fail_on_match: "true"

      # --- Existence checks (fail_on_no_match) ---
      # Low min_score — we only want to confirm the code EXISTS, not score highly.
      # The base all-MiniLM-L6-v2 model gives lower scores on code (~0.25-0.45).

      # Must pass — authentication logic exists
      - name: Require authentication logic
        uses: VecGrep/action@v0.1.5
        with:
          mode: validate
          query: "user authentication login token session verify password"
          path: src/
          min_score: "0.25"
          fail_on_no_match: "true"

      # Must pass — payment logic exists
      - name: Require payment processing logic
        uses: VecGrep/action@v0.1.5
        with:
          mode: validate
          query: "payment charge refund transaction amount"
          path: src/
          min_score: "0.25"
          fail_on_no_match: "true"

      # Must pass — database uses parameterized queries
      - name: Require parameterized database queries
        uses: VecGrep/action@v0.1.5
        with:
          mode: validate
          query: "parameterized query placeholder prepared statement safe execute"
          path: src/
          min_score: "0.25"
          fail_on_no_match: "true"
